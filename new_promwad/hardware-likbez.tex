\input{./branding/common}

\title{Полезные сведения о компьютерной архитектуре}

\begin{document}

\begin{frame}
  \frametitle{}
\end{frame}

\section{Архитектура процессора}
\mode<all>{\input{./slides/processor_arch/processor_arch.tex}}
\section{Периферийные устройства}
\mode<all>{\input{./slides/hardware_protocols/hardware_protocols.tex}}
\section{Разработка для железа}
\subsection{Что на входе}
\begin{frame}
  \frametitle{Входные данные}
  \begin{itemize}
      \item В идеале
        \begin{itemize}
            \item Загрузчик, сконфигурированный под плату
            \item Ядро, сконфигурированное под  плату
            \item Device Tree 
        \end{itemize}
      \item Минимально необходимая информация
        \begin{itemize}
          \item Документация(datasheet) на процессор или SoC
          \item Документация на все устройства подключенные по внешним шинам
          \item Схема соединений
        \end{itemize}
  \end{itemize}
\end{frame}
\begin{frame}
  \frametitle{Что содержится в документации на SoC/процессор/внешние устройства}
  \begin{itemize}
      \item Memory mapping
      \item Hardware controlling registers, описание функций
      \item Архитектура прерываний, используемые прерывания
  \end{itemize}
\end{frame}
\begin{frame}
  \frametitle{Типичные задачи при освоении новой платы}
  \begin{itemize}
      \item Портирование u-boot
      \item Портирование deviceTree
      \item Написание модулей ядра (драйверов устройств)
  \end{itemize}
\end{frame}
\subsection{Представление информации об архитектуре для ядра (devicetree)}
\begin{frame}
  \frametitle{DeviceTree: что это такое?}
\textbf{DeviceTree} -- структура данных, содержащая информацию о конфигурации конкретной платы. 

\vspace{1cm}

Существует в двух модификациях -- человекочитаемая (файлы \texttt{*.dts}) и машиночитаемая (файлы \texttt{*.dtb})

\vspace{1cm}

Бинарный файл devicetree загружается в память одновременно с ядром, и используется ядром для подбора драйверов и загрузки параметров драйверов.
\end{frame}

\begin{frame}
  \frametitle{Пример devicetree файла}
\end{frame}

\begin{frame}
  \frametitle{DeviceTree: Зачем это нужно?}
  \begin{itemize}
     \item Меньше вариантов сборки ядра
     \item Возможность поддерживать новые платы без пересборки ядра
     \item Меньше коммитов в драйвера ядра 
     \item Приспособлены для автоматизации
  \end{itemize}
\end{frame}
\begin{frame}
  \frametitle{Родственные технологии}
  \begin{itemize}
      \item Внутриядерные структуры данных с описанием архитектуры платы (/arch/arm/mach-*) 
      \item UEFI
      \item ACPI (i386 only)
      \item OpenFirmware (PowerPC, Solaris) прямой предок
  \end{itemize}
\end{frame}

\begin{frame}
  \frametitle{Наиболее интересные параметры в описании устройства}
  \begin{itemize}
    \item \texttt{compatible} -- строка, определяет выбор драйвера
    \item \texttt{status} -- строка, используется ли устройство \texttt{"ok"}/\texttt{"disabled"}
  \end{itemize}
\end{frame}

\begin{frame}
  \frametitle{Наиболее важные разделы DeviceTree}
  \begin{itemize}
    \item \textbf{cpus} Процессоры
    \item \textbf{memory} Структура памяти
    \item \textbf{aliases}
    \item \textbf{choosen} Параметры загрузки
  \end{itemize}
\end{frame}

\begin{frame}[fragile]
  \frametitle{Оверлеи пример}
\begin{lstlisting}
// Enable the i2s interface
/dts-v1/;
/plugin/;

/ {
    compatible = "brcm,bcm2708";

    fragment@0 {
        target = <&i2s>;
        __overlay__ {
            status = "okay";
        };
    };
};
\end{lstlisting}
\end{frame}
\begin{frame}[fragile]
 \frametitle{Оверлеи}
\begin{lstlisting}[language=bash]
dtc -@ -I dts -O dtb -o patch.dtbo overlay.dts
dtoverlay patch.dtbo
dtoverlay -r patch.dtbo
\end{lstlisting}
\end{frame}
\end{document}
